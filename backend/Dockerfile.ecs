# Multi-stage build per ridurre dimensione finale
FROM ubuntu:22.04 AS builder

# Evita prompt interattivi durante installazione
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Aggiorna sistema e installa dipendenze base
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    unzip \
    xz-utils \
    zip \
    libglu1-mesa \
    clang \
    cmake \
    ninja-build \
    pkg-config \
    libgtk-3-dev \
    liblzma-dev \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    nano \
    vim \
    htop \
    jq \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Installa Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Skip Docker for now - focus on Flutter + Python
# RUN echo "Docker support will be added in next iteration"

# Installa Flutter SDK
ENV FLUTTER_HOME="/opt/flutter"
ENV PATH="$FLUTTER_HOME/bin:$PATH"

RUN git clone --depth 1 --branch stable https://github.com/flutter/flutter.git $FLUTTER_HOME \
    && $FLUTTER_HOME/bin/flutter doctor \
    && $FLUTTER_HOME/bin/flutter precache \
    && chmod -R 755 $FLUTTER_HOME

# Stage finale ottimizzato
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Installa runtime essenziali prima di copiare
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    unzip \
    nano \
    vim \
    ca-certificates \
    libglu1-mesa \
    python3 \
    python3-pip \
    python3-distutils \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Copia Flutter SDK dal builder
COPY --from=builder /opt/flutter /opt/flutter

# Installa Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Setup environment
ENV FLUTTER_HOME="/opt/flutter"
ENV DART_HOME="$FLUTTER_HOME/bin/cache/dart-sdk"
ENV PATH="$FLUTTER_HOME/bin:$DART_HOME/bin:$PATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PUB_CACHE="/tmp/.pub-cache"

# Crea utente non-root per sicurezza
RUN groupadd -r warpuser && useradd -r -g warpuser warpuser \
    && mkdir -p /tmp/warp-users \
    && chown -R warpuser:warpuser /tmp/warp-users \
    && chmod -R 755 /opt/flutter

# Configura Flutter per container come root (poi switcha a warpuser)
RUN $FLUTTER_HOME/bin/flutter config --no-analytics \
    && $FLUTTER_HOME/bin/flutter precache --no-ios --no-android --no-web \
    && $FLUTTER_HOME/bin/flutter --version

# Crea directory di lavoro
WORKDIR /workspace

# Copia il backend Express
COPY package*.json ./
RUN npm ci --only=production

COPY . .

# Configurazione per ECS
ENV PORT=3000
ENV NODE_ENV=production

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Espone la porta
EXPOSE 3000

# Avvia il server Express
CMD ["node", "ecs-server.js"]