# Multi-stage build per ridurre dimensione finale
FROM ubuntu:22.04 AS builder

# Evita prompt interattivi durante installazione
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Aggiorna sistema e installa dipendenze base
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    unzip \
    xz-utils \
    zip \
    libglu1-mesa \
    clang \
    cmake \
    ninja-build \
    pkg-config \
    libgtk-3-dev \
    liblzma-dev \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Installa Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Installa Flutter SDK
ENV FLUTTER_HOME="/opt/flutter"
ENV PATH="$FLUTTER_HOME/bin:$PATH"

RUN git clone --depth 1 --branch stable https://github.com/flutter/flutter.git $FLUTTER_HOME \
    && $FLUTTER_HOME/bin/flutter doctor \
    && $FLUTTER_HOME/bin/flutter precache --web \
    && chmod -R 755 $FLUTTER_HOME

# Stage finale ottimizzato
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Installa runtime essenziali
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    unzip \
    nano \
    vim \
    ca-certificates \
    libglu1-mesa \
    python3 \
    python3-pip \
    python3-distutils \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Installa Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Copia Flutter SDK dal builder
COPY --from=builder /opt/flutter /opt/flutter

# Setup environment
ENV FLUTTER_HOME="/opt/flutter"
ENV DART_HOME="$FLUTTER_HOME/bin/cache/dart-sdk"
ENV PATH="$FLUTTER_HOME/bin:$DART_HOME/bin:$PATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PUB_CACHE="/tmp/.pub-cache"

# Fix Git ownership issues e configura Flutter
RUN git config --system --add safe.directory /opt/flutter \
    && git config --system --add safe.directory '*' \
    && $FLUTTER_HOME/bin/flutter config --no-analytics \
    && $FLUTTER_HOME/bin/flutter config --enable-web \
    && $FLUTTER_HOME/bin/flutter precache --web \
    && $FLUTTER_HOME/bin/flutter --version

# Crea utente non-root per sicurezza
RUN groupadd -r warpuser && useradd -r -g warpuser -m -d /home/warpuser warpuser \
    && mkdir -p /tmp/projects /tmp/.pub-cache /tmp/warp-users \
    && chown -R warpuser:warpuser /tmp/projects /tmp/.pub-cache /tmp/warp-users /opt/flutter \
    && chmod -R 755 /opt/flutter

# Crea directory di lavoro
WORKDIR /workspace
RUN chown -R warpuser:warpuser /workspace

# Copia e installa dipendenze Node.js
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# Copia il codice del backend
COPY backend/ ./backend/
COPY lambda-handler.js ./
COPY .env* ./

# Fix permessi
RUN chown -R warpuser:warpuser /workspace

# Configurazione per ECS
ENV PORT=3000
ENV NODE_ENV=production
ENV ECS_CONTAINER_MODE=true

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Espone le porte per Flutter web e server backend
EXPOSE 3000 8080 8081 8082 8083 8084

# Cambia all'utente non-root
USER warpuser

# Avvia il server ECS
CMD ["node", "backend/ecs-server.js"]